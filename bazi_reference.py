# bazi_reference.py
"""
八字参考数据库
存储所有静态表格数据，供其他模块查询使用
"""

class BaziReference:
    """八字系统参考数据库"""
    
    # ============================================
    # 基础干支系统
    # ============================================
    
    HEAVENLY_STEMS = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸']
    EARTHLY_BRANCHES = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥']
    
    # 干支对应五行
    STEM_TO_ELEMENT = {
        '甲': '木', '乙': '木',
        '丙': '火', '丁': '火',
        '戊': '土', '己': '土',
        '庚': '金', '辛': '金',
        '壬': '水', '癸': '水'
    }
    
    BRANCH_TO_ELEMENT = {
        '寅': '木', '卯': '木',
        '巳': '火', '午': '火',
        '辰': '土', '未': '土', '戌': '土', '丑': '土',
        '申': '金', '酉': '金',
        '亥': '水', '子': '水'
    }
    
    # 阴阳属性
    YANG_STEMS = ['甲', '丙', '戊', '庚', '壬']
    YIN_STEMS = ['乙', '丁', '己', '辛', '癸']
    
    # ============================================
    # 地支藏干表（模块1.7核心数据）
    # ============================================
    
    HIDDEN_STEMS = {
        "子": ["癸", "壬"],
        "丑": ["己", "癸", "辛"],
        "寅": ["甲", "丙", "戊"],
        "卯": ["乙"],
        "辰": ["戊", "乙", "癸"],
        "巳": ["丙", "戊", "庚"],
        "午": ["丁", "己"],
        "未": ["己", "丁", "乙"],
        "申": ["庚", "壬", "戊"],
        "酉": ["辛"],
        "戌": ["戊", "辛", "丁"],
        "亥": ["壬", "甲"]
    }
    
    # ============================================
    # 月令司令表（模块1.14核心数据）
    # 依据《渊海子平》《三命通会》
    # ============================================
    
    SILING_TABLE = {
        "寅": [
            {"stem": "戊", "period": "本气", "days": 7},
            {"stem": "丙", "period": "中气", "days": 7},
            {"stem": "甲", "period": "余气", "days": 16}
        ],
        "卯": [
            {"stem": "乙", "period": "本气", "days": 10},
            {"stem": "甲", "period": "余气", "days": 20}
        ],
        "辰": [
            {"stem": "戊", "period": "本气", "days": 9},
            {"stem": "乙", "period": "中气", "days": 3},
            {"stem": "癸", "period": "余气", "days": 18}
        ],
        "巳": [
            {"stem": "丙", "period": "本气", "days": 7},
            {"stem": "戊", "period": "中气", "days": 9},
            {"stem": "庚", "period": "余气", "days": 14}
        ],
        "午": [
            {"stem": "丁", "period": "本气", "days": 10},
            {"stem": "己", "period": "中气", "days": 9},
            {"stem": "丁", "period": "余气", "days": 11}
        ],
        "未": [
            {"stem": "己", "period": "本气", "days": 9},
            {"stem": "丁", "period": "中气", "days": 3},
            {"stem": "乙", "period": "余气", "days": 18}
        ],
        "申": [
            {"stem": "庚", "period": "本气", "days": 7},
            {"stem": "壬", "period": "中气", "days": 7},
            {"stem": "戊", "period": "余气", "days": 16}
        ],
        "酉": [
            {"stem": "辛", "period": "本气", "days": 10},
            {"stem": "庚", "period": "余气", "days": 20}
        ],
        "戌": [
            {"stem": "戊", "period": "本气", "days": 9},
            {"stem": "辛", "period": "中气", "days": 3},
            {"stem": "丁", "period": "余气", "days": 18}
        ],
        "亥": [
            {"stem": "壬", "period": "本气", "days": 7},
            {"stem": "甲", "period": "中气", "days": 15},
            {"stem": "壬", "period": "余气", "days": 8}
        ],
        "子": [
            {"stem": "癸", "period": "本气", "days": 9},
            {"stem": "壬", "period": "余气", "days": 21}
        ],
        "丑": [
            {"stem": "己", "period": "本气", "days": 9},
            {"stem": "癸", "period": "中气", "days": 3},
            {"stem": "辛", "period": "余气", "days": 18}
        ]
    }
    
    # ============================================
    # 十神生克关系表（模块1.9核心数据）
    # ============================================
    
    # 十神判断：基于五行生克关系
    # 我生者为食伤，生我者为印，克我者为官杀，我克者为财，同类为比劫
    SHISHEN_RULES = {
        # 格式：(日干五行, 他干五行, 阴阳关系) -> 十神
        # 阴阳关系：same=同性, diff=异性
        
        # 木日主
        ('木', '木', 'same'): '比肩',
        ('木', '木', 'diff'): '劫财',
        ('木', '火', 'same'): '食神',
        ('木', '火', 'diff'): '伤官',
        ('木', '土', 'same'): '偏财',
        ('木', '土', 'diff'): '正财',
        ('木', '金', 'same'): '七杀',
        ('木', '金', 'diff'): '正官',
        ('木', '水', 'same'): '偏印',
        ('木', '水', 'diff'): '正印',
        
        # 火日主
        ('火', '火', 'same'): '比肩',
        ('火', '火', 'diff'): '劫财',
        ('火', '土', 'same'): '食神',
        ('火', '土', 'diff'): '伤官',
        ('火', '金', 'same'): '偏财',
        ('火', '金', 'diff'): '正财',
        ('火', '水', 'same'): '七杀',
        ('火', '水', 'diff'): '正官',
        ('火', '木', 'same'): '偏印',
        ('火', '木', 'diff'): '正印',
        
        # 土日主
        ('土', '土', 'same'): '比肩',
        ('土', '土', 'diff'): '劫财',
        ('土', '金', 'same'): '食神',
        ('土', '金', 'diff'): '伤官',
        ('土', '水', 'same'): '偏财',
        ('土', '水', 'diff'): '正财',
        ('土', '木', 'same'): '七杀',
        ('土', '木', 'diff'): '正官',
        ('土', '火', 'same'): '偏印',
        ('土', '火', 'diff'): '正印',
        
        # 金日主
        ('金', '金', 'same'): '比肩',
        ('金', '金', 'diff'): '劫财',
        ('金', '水', 'same'): '食神',
        ('金', '水', 'diff'): '伤官',
        ('金', '木', 'same'): '偏财',
        ('金', '木', 'diff'): '正财',
        ('金', '火', 'same'): '七杀',
        ('金', '火', 'diff'): '正官',
        ('金', '土', 'same'): '偏印',
        ('金', '土', 'diff'): '正印',
        
        # 水日主
        ('水', '水', 'same'): '比肩',
        ('水', '水', 'diff'): '劫财',
        ('水', '木', 'same'): '食神',
        ('水', '木', 'diff'): '伤官',
        ('水', '火', 'same'): '偏财',
        ('水', '火', 'diff'): '正财',
        ('水', '土', 'same'): '七杀',
        ('水', '土', 'diff'): '正官',
        ('水', '金', 'same'): '偏印',
        ('水', '金', 'diff'): '正印',
    }
    
    # ============================================
    # 十二长生表（模块1.13核心数据）
    # ============================================
    
    CHANGSHENG_TABLE = {
        '甲': {
            '亥': '长生', '子': '沐浴', '丑': '冠带', '寅': '临官', '卯': '帝旺', '辰': '衰',
            '巳': '病', '午': '死', '未': '墓', '申': '绝', '酉': '胎', '戌': '养'
        },
        '乙': {
            '午': '长生', '巳': '沐浴', '辰': '冠带', '卯': '临官', '寅': '帝旺', '丑': '衰',
            '子': '病', '亥': '死', '戌': '墓', '酉': '绝', '申': '胎', '未': '养'
        },
        '丙': {
            '寅': '长生', '卯': '沐浴', '辰': '冠带', '巳': '临官', '午': '帝旺', '未': '衰',
            '申': '病', '酉': '死', '戌': '墓', '亥': '绝', '子': '胎', '丑': '养'
        },
        '丁': {
            '酉': '长生', '申': '沐浴', '未': '冠带', '午': '临官', '巳': '帝旺', '辰': '衰',
            '卯': '病', '寅': '死', '丑': '墓', '子': '绝', '亥': '胎', '戌': '养'
        },
        '戊': {
            '寅': '长生', '卯': '沐浴', '辰': '冠带', '巳': '临官', '午': '帝旺', '未': '衰',
            '申': '病', '酉': '死', '戌': '墓', '亥': '绝', '子': '胎', '丑': '养'
        },
        '己': {
            '酉': '长生', '申': '沐浴', '未': '冠带', '午': '临官', '巳': '帝旺', '辰': '衰',
            '卯': '病', '寅': '死', '丑': '墓', '子': '绝', '亥': '胎', '戌': '养'
        },
        '庚': {
            '巳': '长生', '午': '沐浴', '未': '冠带', '申': '临官', '酉': '帝旺', '戌': '衰',
            '亥': '病', '子': '死', '丑': '墓', '寅': '绝', '卯': '胎', '辰': '养'
        },
        '辛': {
            '子': '长生', '亥': '沐浴', '戌': '冠带', '酉': '临官', '申': '帝旺', '未': '衰',
            '午': '病', '巳': '死', '辰': '墓', '卯': '绝', '寅': '胎', '丑': '养'
        },
        '壬': {
            '申': '长生', '酉': '沐浴', '戌': '冠带', '亥': '临官', '子': '帝旺', '丑': '衰',
            '寅': '病', '卯': '死', '辰': '墓', '巳': '绝', '午': '胎', '未': '养'
        },
        '癸': {
            '卯': '长生', '寅': '沐浴', '丑': '冠带', '子': '临官', '亥': '帝旺', '戌': '衰',
            '酉': '病', '申': '死', '未': '墓', '午': '绝', '巳': '胎', '辰': '养'
        }
    }
    
    # ============================================
    # 旺相休囚死表（模块1.11核心数据）
    # ============================================
    
    WANGXIANG_TABLE = {
        "春季": {"木": "旺", "火": "相", "水": "休", "金": "囚", "土": "死"},
        "夏季": {"火": "旺", "土": "相", "木": "休", "水": "囚", "金": "死"},
        "秋季": {"金": "旺", "水": "相", "土": "休", "火": "囚", "木": "死"},
        "冬季": {"水": "旺", "木": "相", "金": "休", "火": "囚", "土": "死"}
    }
    
    # 地支对应季节
    BRANCH_TO_SEASON = {
        '寅': '春季', '卯': '春季', '辰': '春季',
        '巳': '夏季', '午': '夏季', '未': '夏季',
        '申': '秋季', '酉': '秋季', '戌': '秋季',
        '亥': '冬季', '子': '冬季', '丑': '冬季'
    }
    
    # ============================================
    # 调候速查表（模块1.11核心数据）
    # 依据《穷通宝鉴》精简版
    # ============================================
    
    TIAOHOU_TABLE = {
        # 甲木
        "甲寅": "丙火为主，癸水为辅", "甲卯": "庚金为主，丙火为辅",
        "甲辰": "庚金为先，丁火次之", "甲巳": "癸水为先，庚金次之",
        "甲午": "癸水为主，庚金为辅", "甲未": "癸水为先，庚金次之",
        "甲申": "庚金为先，丙丁为辅", "甲酉": "庚金为主，丙丁为辅",
        "甲戌": "庚金为先，癸水为辅", "甲亥": "庚金为先，丙火为辅",
        "甲子": "丁火为先，庚金为辅", "甲丑": "丁火为主，庚金为辅",
        
        # 乙木
        "乙寅": "丙火为主，癸水为辅", "乙卯": "丙火为主，癸水为辅",
        "乙辰": "癸水为主，丙火为辅", "乙巳": "癸水为主",
        "乙午": "癸水为主，丙火为辅", "乙未": "癸水为主，丙火为辅",
        "乙申": "丙火为先，癸水次之", "乙酉": "丙火为先，癸水次之",
        "乙戌": "癸水为主，丙火为辅", "乙亥": "丙火为主，癸水为辅",
        "乙子": "丙火为主，癸水为辅", "乙丑": "丙火为主，癸水为辅",
        
        # 丙火
        "丙寅": "壬水为先", "丙卯": "壬水为先",
        "丙辰": "壬水为先，甲木为辅", "丙巳": "壬水为先，庚金为辅",
        "丙午": "壬水为先，庚金为辅", "丙未": "壬水为先，庚金为辅",
        "丙申": "壬水为先，戊土为辅", "丙酉": "壬水为先，戊土为辅",
        "丙戌": "甲木为先，壬水为辅", "丙亥": "甲木为先，忌壬癸水",
        "丙子": "壬水为尊，戊土为佐", "丙丑": "壬水为先，戊土为辅",
        
        # 丁火
        "丁寅": "甲木为主", "丁卯": "甲木为主，庚金为辅",
        "丁辰": "甲木为先，庚金为辅", "丁巳": "甲木为先，庚金为辅",
        "丁午": "壬水为先，甲木为辅", "丁未": "甲木为先，庚金为辅",
        "丁申": "甲木为先，庚金为辅", "丁酉": "甲木为先，庚金为辅",
        "丁戌": "甲木为先，庚金为辅", "丁亥": "甲木为主，庚金为辅",
        "丁子": "甲木为主，庚金为辅", "丁丑": "甲木为主，庚金为辅",
        
        # 戊土
        "戊寅": "丙火为先，甲木为辅", "戊卯": "丙火为先，甲木为辅",
        "戊辰": "丙火为先，甲木为辅", "戊巳": "癸水为先，丙火为辅",
        "戊午": "癸水为先，丙火为辅", "戊未": "癸水为先，丙火为辅",
        "戊申": "丙火为先，癸水为辅", "戊酉": "丙火为先，癸水为辅",
        "戊戌": "甲木为先，丙火为辅", "戊亥": "丙火为先，甲木为辅",
        "戊子": "丙火为先，甲木为辅", "戊丑": "丙火为先，甲木为辅",
        
        # 己土
        "己寅": "丙火为先，癸水为辅", "己卯": "丙火为先，癸水为辅",
        "己辰": "丙火为先，癸水为辅", "己巳": "癸水为先，丙火为辅",
        "己午": "癸水为先，丙火为辅", "己未": "癸水为先，丙火为辅",
        "己申": "丙火为先，癸水为辅", "己酉": "丙火为先，癸水为辅",
        "己戌": "丙火为先，甲木为辅", "己亥": "丙火为先，甲木为辅",
        "己子": "丙火为先，甲木为辅", "己丑": "丙火为先，甲木为辅",
        
        # 庚金
        "庚寅": "丁火为先，甲木为辅", "庚卯": "丁火为先，甲木为辅",
        "庚辰": "丁火为先，甲木为辅", "庚巳": "壬水为先，戊土为辅",
        "庚午": "壬水为先，戊土为辅", "庚未": "丁火为先，甲木为辅",
        "庚申": "丁火为先，甲木为辅", "庚酉": "丁火为先，甲木为辅",
        "庚戌": "甲木为先，壬水为辅", "庚亥": "丁火为先，丙火为辅",
        "庚子": "丁火为先，丙火为辅", "庚丑": "丁火为先，丙火为辅",
        
        # 辛金
        "辛寅": "壬水为先", "辛卯": "壬水为先",
        "辛辰": "壬水为先", "辛巳": "壬水为先，甲木为辅",
        "辛午": "壬水为先，甲木为辅", "辛未": "壬水为先，甲木为辅",
        "辛申": "壬水为先，甲木为辅", "辛酉": "壬水为先，甲木为辅",
        "辛戌": "壬水为先，甲木为辅", "辛亥": "壬水为主，丙火为辅",
        "辛子": "丙火为主，壬水为辅", "辛丑": "丙火为主，壬水为辅",
        
        # 壬水
        "壬寅": "庚金为先，丙火为辅", "壬卯": "庚金为先，丙火为辅",
        "壬辰": "庚金为先，甲木为辅", "壬巳": "庚金为先，壬水为辅",
        "壬午": "庚金为先，癸水为辅", "壬未": "庚金为先，甲木为辅",
        "壬申": "戊土为先，丙火为辅", "壬酉": "甲木为先，庚金为辅",
        "壬戌": "甲木为先，庚金为辅", "壬亥": "戊土为先，丙火为辅",
        "壬子": "戊土为先，丙火为辅", "壬丑": "丙火为先，庚金为辅",
        
        # 癸水
        "癸寅": "辛金为先，丙火为辅", "癸卯": "庚金为先，辛金为辅",
        "癸辰": "丙火为先，辛金为辅", "癸巳": "庚金为先，辛金为辅",
        "癸午": "庚金为先，辛金为辅", "癸未": "庚金为先，辛金为辅",
        "癸申": "丁火为先，庚金为辅", "癸酉": "辛金为先，丙火为辅",
        "癸戌": "辛金为先，甲木为辅", "癸亥": "庚辛金为先，戊土为辅",
        "癸子": "丙火为先，辛金为辅", "癸丑": "丙火为先，辛金为辅"
    }
    
    # ============================================
    # 纳音表（可选，用于增强报告）
    # ============================================
    
    NAYIN_TABLE = {
        "甲子": "海中金", "乙丑": "海中金",
        "丙寅": "炉中火", "丁卯": "炉中火",
        "戊辰": "大林木", "己巳": "大林木",
        "庚午": "路旁土", "辛未": "路旁土",
        "壬申": "剑锋金", "癸酉": "剑锋金",
        "甲戌": "山头火", "乙亥": "山头火",
        "丙子": "涧下水", "丁丑": "涧下水",
        "戊寅": "城头土", "己卯": "城头土",
        "庚辰": "白蜡金", "辛巳": "白蜡金",
        "壬午": "杨柳木", "癸未": "杨柳木",
        "甲申": "泉中水", "乙酉": "泉中水",
        "丙戌": "屋上土", "丁亥": "屋上土",
        "戊子": "霹雳火", "己丑": "霹雳火",
        "庚寅": "松柏木", "辛卯": "松柏木",
        "壬辰": "长流水", "癸巳": "长流水",
        "甲午": "砂中金", "乙未": "砂中金",
        "丙申": "山下火", "丁酉": "山下火",
        "戊戌": "平地木", "己亥": "平地木",
        "庚子": "壁上土", "辛丑": "壁上土",
        "壬寅": "金箔金", "癸卯": "金箔金",
        "甲辰": "覆灯火", "乙巳": "覆灯火",
        "丙午": "天河水", "丁未": "天河水",
        "戊申": "大驿土", "己酉": "大驿土",
        "庚戌": "钗钏金", "辛亥": "钗钏金",
        "壬子": "桑柘木", "癸丑": "桑柘木",
        "甲寅": "大溪水", "乙卯": "大溪水",
        "丙辰": "沙中土", "丁巳": "沙中土",
        "戊午": "天上火", "己未": "天上火",
        "庚申": "石榴木", "辛酉": "石榴木",
        "壬戌": "大海水", "癸亥": "大海水"
    }
    
    # ============================================
    # 工具方法
    # ============================================
    
    @staticmethod
    def get_ganzhi(year):
        """
        根据年份获取干支
        公元4年是甲子年（干支纪年起点）
        """
        offset = (year - 4) % 60
        gan_index = offset % 10
        zhi_index = offset % 12
        return BaziReference.HEAVENLY_STEMS[gan_index] + BaziReference.EARTHLY_BRANCHES[zhi_index]
    
    @staticmethod
    def get_stem_element(stem):
        """获取天干对应的五行"""
        return BaziReference.STEM_TO_ELEMENT.get(stem)
    
    @staticmethod
    def get_branch_element(branch):
        """获取地支对应的五行"""
        return BaziReference.BRANCH_TO_ELEMENT.get(branch)
    
    @staticmethod
    def get_hidden_stems(branch):
        """获取地支藏干"""
        return BaziReference.HIDDEN_STEMS.get(branch, [])
    
    @staticmethod
    def get_shishen(day_gan, other_gan):
        """
        计算十神
        
        Args:
            day_gan: 日主天干
            other_gan: 他干
        
        Returns:
            十神名称（如"正印"、"偏财"等）
        """
        if day_gan == other_gan:
            # 同干判断阴阳
            if day_gan in BaziReference.YANG_STEMS:
                return '比肩'
            else:
                return '比肩'
        
        day_element = BaziReference.STEM_TO_ELEMENT[day_gan]
        other_element = BaziReference.STEM_TO_ELEMENT[other_gan]
        
        # 判断阴阳关系
        day_is_yang = day_gan in BaziReference.YANG_STEMS
        other_is_yang = other_gan in BaziReference.YANG_STEMS
        
        if day_is_yang == other_is_yang:
            yinyang = 'same'  # 同性
        else:
            yinyang = 'diff'  # 异性
        
        key = (day_element, other_element, yinyang)
        return BaziReference.SHISHEN_RULES.get(key, '未知')
    
    @staticmethod
    def get_changsheng_status(day_gan, branch):
        """
        查询十二长生状态
        
        Args:
            day_gan: 日主天干
            branch: 地支
        
        Returns:
            长生状态（如"帝旺"、"绝"等）
        """
        return BaziReference.CHANGSHENG_TABLE.get(day_gan, {}).get(branch, '未知')
    
    @staticmethod
    def get_siling_info(month_branch, days_since_jie, day_gan=None):
        """
        计算月令司令神
        
        Args:
            month_branch: 月支
            days_since_jie: 距离节气的天数
            day_gan: 日干（用于计算十神，可选）
        
        Returns:
            司令信息字典
        """
        siling_periods = BaziReference.SILING_TABLE.get(month_branch, [])
    
        cumulative_days = 0
        for period in siling_periods:
            cumulative_days += period["days"]
            if days_since_jie < cumulative_days:
                days_into = days_since_jie - (cumulative_days - period["days"])
                
                result = {
                    "stem": period["stem"],
                    "element": BaziReference.STEM_TO_ELEMENT[period["stem"]],
                    "period": period["period"],
                    "days_into": round(days_into, 2),
                    "strength": 1.0  # 🆕 新增
                }
                
                # 🆕 如果提供了日干，计算十神
                if day_gan:
                    result["shishen"] = BaziReference.get_shishen(day_gan, period["stem"])
                
                return result
        
        return None
    
    @staticmethod
    def get_season(month_branch):
        """获取月支对应的季节"""
        return BaziReference.BRANCH_TO_SEASON.get(month_branch, '未知')
    
    @staticmethod
    def get_wangxiang(season, element):
        """
        查询旺相休囚死
        
        Args:
            season: 季节（如"春季"）
            element: 五行（如"木"）
        
        Returns:
            旺衰状态（如"旺"、"囚"等）
        """
        return BaziReference.WANGXIANG_TABLE.get(season, {}).get(element, '未知')
    
    @staticmethod
    def get_tiaohou(day_gan, month_branch):
        """
        查询调候用神
        
        Args:
            day_gan: 日干
            month_branch: 月支
        
        Returns:
            调候建议字符串
        """
        key = day_gan + month_branch
        return BaziReference.TIAOHOU_TABLE.get(key, '无特殊调候要求')
    
    @staticmethod
    def get_nayin(gan, zhi):
        """获取纳音"""
        pillar = gan + zhi
        return BaziReference.NAYIN_TABLE.get(pillar, '未知')